{% extends "templates/web.html" %}

{% block title %}Parlo License Dashboard{% endblock %}

{% block page_content %}
<div class="container-fluid mt-4">
    {% if no_organization %}
    <div class="alert alert-warning">
        <h4>No Organization Assigned</h4>
        <p>{{ message }}</p>
        {% if available_organizations %}
        <form id="request-access-form" class="mt-3">
            <div class="form-group">
                <label>Select Organization to Request Access:</label>
                <select class="form-control" id="request-org" style="max-width: 400px;">
                    <option value="">-- Select Organization --</option>
                    {% for org in available_organizations %}
                    <option value="{{ org.name }}">{{ org.organization_name or org.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Request Access</button>
        </form>
        {% endif %}
    </div>
    {% elif no_license_setup %}
    <div class="alert alert-warning">
        <h4>License Not Configured</h4>
        <p>{{ message }}</p>
    </div>
    {% else %}
    
    <!-- Organization Header -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h2 class="mb-0">{{ organization }}</h2>
                    <p class="text-muted mb-0">Campaign Code: <strong>{{ campaign_code or 'Not Set' }}</strong></p>
                </div>
                <div class="col-md-4 text-right">
                    {% if available_organizations and available_organizations|length > 1 %}
                    <select class="form-control" id="org-switcher" onchange="switchOrganization(this.value)">
                        {% for org in available_organizations %}
                        <option value="{{ org }}" {% if org == organization %}selected{% endif %}>{{ org }}</option>
                        {% endfor %}
                    </select>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- License Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Licenses</h5>
                    <h2>{{ total_licenses }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Used Licenses</h5>
                    <h2>{{ used_licenses }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Available</h5>
                    <h2>{{ available_licenses }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Usage</h5>
                    <h2>{{ usage_percentage }}%</h2>
                </div>
            </div>
        </div>
    </div>
    
    {% if license_warning %}
    <div class="alert alert-danger">
        <i class="fa fa-exclamation-triangle"></i> {{ license_warning }}
    </div>
    {% endif %}
    
    <!-- Action Buttons -->
    <div class="mb-4">
        <button class="btn btn-primary btn-lg" onclick="showBulkUpload()">
            <i class="fa fa-upload"></i> Bulk Upload Licenses
        </button>
        <button class="btn btn-secondary btn-lg ml-2" onclick="downloadTemplate()">
            <i class="fa fa-download"></i> Download Excel Template
        </button>
        <button class="btn btn-info btn-lg ml-2" onclick="refreshDashboard()">
            <i class="fa fa-refresh"></i> Refresh
        </button>
    </div>
    
    <!-- Search Bar -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="input-group">
                <input type="text" class="form-control" id="search-input" placeholder="Search by email or phone number...">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" onclick="searchLicenses()">
                        <i class="fa fa-search"></i> Search
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabs for Allocated and Unallocated -->
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-toggle="tab" href="#allocated">
                Allocated Licenses ({{ allocated_licenses|length }})
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#unallocated">
                Unallocated Leads ({{ unallocated_leads|length }})
            </a>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content mt-3">
        <!-- Allocated Tab -->
        <div id="allocated" class="tab-pane active">
            <div class="card">
                <div class="card-body">
                    {% if allocated_licenses %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>License Number</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Allocated Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for license in allocated_licenses %}
                                <tr>
                                    <td><strong>{{ license.license_number }}</strong></td>
                                    <td>{{ license.first_name }} {{ license.last_name }}</td>
                                    <td>{{ license.email_id or '-' }}</td>
                                    <td>{{ license.phone or '-' }}</td>
                                    <td>{{ frappe.utils.format_datetime(license.license_allocated_date, "dd/MM/yyyy HH:mm") }}</td>
                                    <td>
                                        <a href="/app/contact/{{ license.name }}" class="btn btn-sm btn-outline-primary">View</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No licenses allocated yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Unallocated Tab -->
        <div id="unallocated" class="tab-pane">
            <div class="card">
                <div class="card-body">
                    {% if unallocated_leads %}
                    <div class="mb-3">
                        <button class="btn btn-success" onclick="allocateSelected()" id="allocate-btn" disabled>
                            <i class="fa fa-check"></i> Allocate Selected
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                                    </th>
                                    <th>Lead Name</th>
                                    <th>Email</th>
                                    <th>Mobile</th>
                                    <th>Parlo Verified</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lead in unallocated_leads %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="lead-checkbox" value="{{ lead.name }}" onchange="updateAllocateButton()">
                                    </td>
                                    <td>{{ lead.lead_name }}</td>
                                    <td>{{ lead.email_id or '-' }}</td>
                                    <td>{{ lead.mobile_no or '-' }}</td>
                                    <td>
                                        {% if lead.parlo_verified %}
                                        <span class="badge badge-success">Verified</span>
                                        {% else %}
                                        <span class="badge badge-secondary">Not Verified</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ frappe.utils.format_datetime(lead.creation, "dd/MM/yyyy") }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="allocateSingle('{{ lead.name }}')">Allocate</button>
                                        <a href="/app/lead/{{ lead.name }}" class="btn btn-sm btn-outline-primary">View</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No unallocated leads found. Leads must have campaign code: <strong>{{ campaign_code }}</strong></p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    {% endif %}
</div>

<!-- Bulk Upload Modal -->
<div class="modal fade" id="bulkUploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk License Upload</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bulk-upload-form">
                    <div class="form-group">
                        <label>Select Excel File</label>
                        <input type="file" class="form-control-file" id="bulk-file" accept=".xlsx,.xls" required>
                        <small class="text-muted">
                            Excel must have columns: phonenumber, full_name, email, campaign_code (optional)
                        </small>
                    </div>
                    <div id="upload-preview" class="mt-3"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="processBulkUpload()">Validate & Upload</button>
            </div>
        </div>
    </div>
</div>

<script>
// Dashboard Functions
function switchOrganization(org) {
    window.location.href = `/parlo-dashboard?organization=${encodeURIComponent(org)}`;
}

function refreshDashboard() {
    window.location.reload();
}

function searchLicenses() {
    const searchTerm = document.getElementById('search-input').value;
    if (!searchTerm) {
        frappe.msgprint('Please enter email or phone to search');
        return;
    }
    
    frappe.call({
        method: 'parlo_license_manager.www.parlo_dashboard.search_contacts_and_leads',
        args: {
            search_term: searchTerm,
            organization: '{{ organization }}'
        },
        callback: function(r) {
            if (r.message) {
                // Display search results
                console.log(r.message);
                frappe.msgprint('Search completed. Check console for results.');
            }
        }
    });
}

// Bulk Upload Functions
function showBulkUpload() {
    $('#bulkUploadModal').modal('show');
}

function downloadTemplate() {
    frappe.call({
        method: 'parlo_license_manager.utils.bulk_upload.get_bulk_upload_template',
        callback: function(r) {
            if (r.message && r.message.success) {
                // Create download link
                const blob = new Blob([r.message.file_content], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'license_upload_template.xlsx';
                a.click();
            }
        }
    });
}

function processBulkUpload() {
    const fileInput = document.getElementById('bulk-file');
    if (!fileInput.files[0]) {
        frappe.msgprint('Please select a file');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        frappe.call({
            method: 'parlo_license_manager.utils.bulk_upload.validate_bulk_upload',
            args: {
                file_content: e.target.result,
                organization_name: '{{ organization }}'
            },
            callback: function(r) {
                if (r.message) {
                    if (r.message.success) {
                        // Show preview
                        let preview = `
                            <div class="alert alert-info">
                                <p>Total Records: ${r.message.total_records}</p>
                                <p>Valid: ${r.message.valid_records}</p>
                                <p>Invalid: ${r.message.invalid_records}</p>
                                <p>Available Licenses: ${r.message.available_licenses}</p>
                            </div>
                        `;
                        
                        if (r.message.warning_message) {
                            preview += `<div class="alert alert-warning">${r.message.warning_message}</div>`;
                        }
                        
                        document.getElementById('upload-preview').innerHTML = preview;
                        
                        if (r.message.can_proceed) {
                            frappe.confirm(
                                'Proceed with allocation?',
                                () => processAllocation(r.message.records)
                            );
                        }
                    } else {
                        frappe.msgprint(r.message.error);
                    }
                }
            }
        });
    };
    reader.readAsArrayBuffer(fileInput.files[0]);
}

function processAllocation(records) {
    frappe.call({
        method: 'parlo_license_manager.utils.bulk_upload.process_bulk_allocation',
        args: {
            validated_records: records,
            organization_name: '{{ organization }}'
        },
        callback: function(r) {
            if (r.message) {
                if (r.message.success) {
                    frappe.msgprint(r.message.message);
                    $('#bulkUploadModal').modal('hide');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    frappe.msgprint(r.message.error);
                }
            }
        }
    });
}

// Lead Allocation Functions
function toggleSelectAll() {
    const selectAll = document.getElementById('select-all').checked;
    document.querySelectorAll('.lead-checkbox').forEach(cb => {
        cb.checked = selectAll;
    });
    updateAllocateButton();
}

function updateAllocateButton() {
    const checkedCount = document.querySelectorAll('.lead-checkbox:checked').length;
    document.getElementById('allocate-btn').disabled = checkedCount === 0;
}

function allocateSingle(leadName) {
    allocateLeads([leadName]);
}

function allocateSelected() {
    const selected = [];
    document.querySelectorAll('.lead-checkbox:checked').forEach(cb => {
        selected.push(cb.value);
    });
    
    if (selected.length === 0) {
        frappe.msgprint('Please select leads to allocate');
        return;
    }
    
    allocateLeads(selected);
}

function allocateLeads(leadNames) {
    frappe.call({
        method: 'parlo_license_manager.www.parlo_dashboard.allocate_licenses_to_leads',
        args: {
            lead_names: leadNames,
            organization: '{{ organization }}'
        },
        callback: function(r) {
            if (r.message) {
                if (r.message.success) {
                    const msg = `Successfully allocated ${r.message.success.length} licenses`;
                    frappe.msgprint(msg);
                    setTimeout(() => window.location.reload(), 2000);
                } else if (r.message.error) {
                    frappe.msgprint(r.message.error);
                }
            }
        }
    });
}

// Request Access
{% if no_organization %}
document.getElementById('request-access-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const org = document.getElementById('request-org').value;
    if (!org) {
        frappe.msgprint('Please select an organization');
        return;
    }
    
    frappe.call({
        method: 'parlo_license_manager.www.parlo_dashboard.request_organization_access',
        args: {
            organization: org,
            reason: 'Requested via dashboard'
        },
        callback: function(r) {
            if (r.message && r.message.success) {
                frappe.msgprint(r.message.message);
            }
        }
    });
});
{% endif %}
</script>
{% endblock %}
